name: Update APT repo
on:
  release: { types: [published] }
  workflow_dispatch:

permissions: { contents: write }

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout gh-pages
        uses: actions/checkout@v4
        with: { ref: gh-pages, fetch-depth: 0 }

      - name: Install repo tools
        run: |
          sudo apt-get update
          sudo apt-get install -y dpkg-dev apt-utils jq
          sudo snap install gh || true

      - name: Prepare tree
        run: |
          mkdir -p dists/stable/main/binary-amd64
          mkdir -p pool/main/d/demodebcli

      - name: Download latest .deb from Releases
        env: { GH_TOKEN: ${{ github.token }} }
        run: |
          mkdir -p incoming
          gh release download --repo "$GITHUB_REPOSITORY" \
            --pattern 'demodebcli_*_amd64.deb' --dir incoming --clobber
          ls -l incoming
          cp incoming/demodebcli_*_amd64.deb pool/main/d/demodebcli/

      - name: Build Packages indexes
        run: |
          dpkg-scanpackages -m pool /dev/null > dists/stable/main/binary-amd64/Packages
          gzip -f -9 dists/stable/main/binary-amd64/Packages
          xz -f  dists/stable/main/binary-amd64/Packages

      - name: Build Release (unsigned)
        run: |
          # Generate Release with correct Suite/Components/Architectures and hashes
          cat >release.conf <<'EOF'
          APT::FTPArchive::Release::Suite "stable";
          APT::FTPArchive::Release::Codename "stable";
          APT::FTPArchive::Release::Components "main";
          APT::FTPArchive::Release::Architectures "amd64";
          EOF
          apt-ftparchive -c=release.conf release dists/stable > dists/stable/Release
          # Optionally also create InRelease (unsigned cleartext) â€“ not required with [trusted=yes]
          # awk '1; END{print ""}' dists/stable/Release > dists/stable/InRelease

      - name: Commit & push
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Publish APT repo"
          branch: gh-pages
          file_pattern: dists/** pool/**
